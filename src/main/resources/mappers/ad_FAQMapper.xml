<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.shop.mapper/Ad_FAQMapper">

	<select id="FAQList" parameterType="Criteria" resultType="FAQVO">
		select faq_num, FAQ_TITLE, FAQ_WRITER, FAQ_CONTENT, FAQ_WRITEDATE, FAQ_REF, FAQ_RE_LEVEL, FAQ_RE_STEP, FAQ_LASTUPDATE, WRITER_ONLY,admin_reply
		from faq_tbl where faq_ref = 0 and rownum
		 between #{rowStart} and #{rowEnd}
		 order by faq_writedate desc
	</select>
	
	<select id="totalFAQ" resultType="int">
		select count(faq_num) from faq_tbl where faq_ref = 0
	</select>
	
	<select id="count_reply" resultType="HashMap">
		select count(faq_num) count,faq_ref from faq_tbl
		where faq_ref != 0
		and faq_writer != ' '
		group by faq_ref
	</select>
	
	<select id="readFAQ" parameterType="int" resultType="FAQVO">
		select faq_num, FAQ_TITLE, FAQ_WRITER, FAQ_CONTENT, FAQ_WRITEDATE, FAQ_REF, FAQ_RE_LEVEL, FAQ_RE_STEP, FAQ_LASTUPDATE, WRITER_ONLY,admin_reply
		from faq_tbl
		where faq_num = #{num}
	</select>
	
	<select id="readReply" parameterType="int" resultType="FAQVO">
		select faq_num, FAQ_TITLE, FAQ_WRITER, FAQ_CONTENT, FAQ_WRITEDATE, FAQ_REF, FAQ_RE_LEVEL, FAQ_RE_STEP, FAQ_LASTUPDATE, WRITER_ONLY,admin_reply
		from faq_tbl
		where faq_ref = #{num}
		order by faq_re_step desc
	</select>
	
	<insert id="write_reply" parameterType="FAQVO">
		insert into faq_tbl(faq_num,faq_writer,faq_content,faq_ref,faq_re_level,faq_re_step) 
		values (seq_FAQ_id.nextval,#{faq_writer},#{faq_content},#{faq_ref},1,
			(select nvl(max(faq_re_step),0)+1 from faq_tbl
			where faq_ref = #{faq_ref}))
	</insert>
	
	<insert id="write_re_reply" parameterType="FAQVO">
		insert into faq_tbl(faq_num,faq_writer,faq_content,faq_ref,faq_re_level,faq_re_step) values
		(seq_faq_id.nextval,#{faq_writer},#{faq_content},#{faq_ref},#{faq_re_level}+1,#{faq_re_step})
	</insert>
	
	<update id="add_re_step" parameterType="FAQVO">
		update faq_tbl a set
		faq_re_step = (select faq_re_step + 1 from faq_tbl b where a.faq_num = b.faq_num)
		where faq_ref = #{faq_ref}
		and faq_re_step >= #{faq_re_step}
	</update>

	<update id="admin_reply" parameterType="int">
		update faq_tbl set
		admin_reply = 'Y'
		where faq_num = #{num}
	</update>
	
	<delete id="deleteFAQ" parameterType="int">
		delete from faq_tbl where faq_num = #{num} or faq_ref = #{num}
	</delete>
	
	<delete id="deleteList" parameterType="List">
		delete from faq_tbl where faq_num in
			<foreach item="item" index="index" collection="list" separator="," close=")" open="(">#{item}</foreach>
			or faq_ref in
			<foreach item="item" index="index" collection="list" separator="," close=")" open="(">#{item}</foreach>
	</delete>
	
	<update id="delReply" parameterType="int">
		update faq_tbl set
		faq_writer = ' ',
		faq_content = '삭제된 댓글입니다.'
		where faq_num = #{faq_num}
	</update>
	
	<update id="deleteReplyList" parameterType="List">
		update faq_tbl set
		faq_writer = ' ',
		faq_content = '삭제된 댓글입니다.'
		where faq_num in 
			<foreach item="item" index="index" collection="list" separator="," close=")" open="(">#{item}</foreach>
	</update>
</mapper>